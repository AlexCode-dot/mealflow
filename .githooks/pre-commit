#!/usr/bin/env bash
set -euo pipefail

ROOT="$(git rev-parse --show-toplevel)"

run_spotless() {
  local dir="$1"
  pushd "$ROOT/$dir" >/dev/null
  ./mvnw -q spotless:apply
  popd >/dev/null
}

# -------------------------------------------------
# Backend formatting (only if backend files changed)
# -------------------------------------------------
if git diff --cached --name-only | grep -qE '^services/(identity-service|app-api)/'; then
  run_spotless services/identity-service
  run_spotless services/app-api
  echo "Spotless applied for backend services."
else
  echo "No backend changes staged; skipping Spotless."
fi

# -------------------------------------------------
# Expo app lint + format (ONLY Expo staged files)
# -------------------------------------------------
if command -v npm >/dev/null 2>&1; then
  if git diff --cached --name-only | grep -qE '^apps/expo-app/'; then
    echo "Linting Expo app..."
    (cd "$ROOT/apps/expo-app" && npm run lint --silent) || {
      echo "Expo lint failed. Run 'npm install' in apps/expo-app if needed." >&2
      exit 1
    }

    echo "Formatting staged Expo files (prettier)..."

    # Ensure Expo's local prettier is used
    export PATH="$ROOT/apps/expo-app/node_modules/.bin:$PATH"

    # Format ONLY staged files under apps/expo-app (ACMR)
    git diff --cached --name-only -z --diff-filter=ACMR -- 'apps/expo-app' \
      | xargs -0 -r prettier --write

    # Re-stage ONLY those formatted files
    git diff --cached --name-only -z --diff-filter=ACMR -- 'apps/expo-app' \
      | xargs -0 -r git add --

    # Re-stage deletions under apps/expo-app (safe)
    if git diff --cached --name-only --diff-filter=D -- 'apps/expo-app' | grep -q .; then
      git add -u -- 'apps/expo-app' || true
    fi
  else
    echo "No Expo changes staged; skipping Expo lint/format."
  fi
else
  echo "npm not found; skipping Expo lint." >&2
fi
