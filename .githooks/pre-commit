#!/usr/bin/env bash
set -euo pipefail

ROOT="$(git rev-parse --show-toplevel)"

run_spotless() {
  local dir="$1"
  pushd "$ROOT/$dir" >/dev/null
  ./mvnw -q spotless:apply
  popd >/dev/null
}

# -------------------------------------------------
# Backend formatting (only if backend files changed)
# -------------------------------------------------
if git diff --cached --name-only | grep -qE '^services/(identity-service|app-api)/'; then
  run_spotless services/identity-service
  run_spotless services/app-api
  echo "Spotless applied for backend services."
else
  echo "No backend changes staged; skipping Spotless."
fi

# -------------------------------------------------
# Expo app lint + format (STAGED FILES ONLY)
# -------------------------------------------------
if command -v npm >/dev/null 2>&1; then
  echo "Linting Expo app..."

  (cd "$ROOT/apps/expo-app" && npm run lint --silent) || {
    echo "Expo lint failed. Install deps with 'npm install' in apps/expo-app if needed." >&2
    exit 1
  }

  if (cd "$ROOT/apps/expo-app" && npx --yes --quiet lint-staged --version) >/dev/null 2>&1; then
    echo "Formatting staged Expo files (lint-staged)..."

    # Capture exactly what is staged BEFORE lint-staged runs (null-delimited)
    STAGED_ADD="$(git diff --cached --name-only -z --diff-filter=ACMR)"
    STAGED_DEL="$(git diff --cached --name-only -z --diff-filter=D)"

    (cd "$ROOT/apps/expo-app" && npx --yes --quiet lint-staged) || {
      echo "lint-staged failed. Fix errors and try again." >&2
      exit 1
    }

    # Re-stage ONLY what was previously staged (never git add -A)
    if [ -n "$STAGED_ADD" ]; then
      printf '%s' "$STAGED_ADD" | xargs -0 git add --
    fi
# Re-stage deletions safely (never fail the hook on pathspec edge-cases)
if [ -n "$STAGED_DEL" ]; then
  while IFS= read -r -d '' f; do
    # If Git can still "see" the path in index history, stage the deletion.
    # If not, ignore (we don't want commits blocked by pathspec issues).
    git add -u -- "$f" 2>/dev/null || true
  done < <(printf '%s' "$STAGED_DEL")
fi
  else
    echo "lint-staged not installed in apps/expo-app; skipping format-on-commit." >&2
  fi
else
  echo "npm not found; skipping Expo lint." >&2
fi

