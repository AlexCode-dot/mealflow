#!/usr/bin/env bash
set -euo pipefail

ROOT="$(git rev-parse --show-toplevel)"

run_spotless() {
  local dir="$1"
  pushd "$ROOT/$dir" >/dev/null
  ./mvnw -q spotless:apply
  popd >/dev/null
}

# -------------------------------------------------
# Backend formatting (only if backend files changed)
# -------------------------------------------------
if git diff --cached --name-only | grep -qE '^services/(identity-service|app-api)/'; then
  run_spotless services/identity-service
  run_spotless services/app-api
  echo "Spotless applied for backend services."
else
  echo "No backend changes staged; skipping Spotless."
fi

# -------------------------------------------------
# Expo app lint + format (staged files only)
# -------------------------------------------------
if command -v npm >/dev/null 2>&1; then
  echo "Linting Expo app..."
  (cd "$ROOT/apps/expo-app" && npm run lint --silent) || {
    echo "Expo lint failed. Install deps with 'npm install' in apps/expo-app if needed." >&2
    exit 1
  }

  if (cd "$ROOT/apps/expo-app" && npx --yes --quiet lint-staged --version) >/dev/null 2>&1; then
    echo "Formatting staged Expo files (lint-staged)..."
    (cd "$ROOT/apps/expo-app" && npx --yes --quiet lint-staged) || {
      echo "lint-staged failed. Fix errors and try again." >&2
      exit 1
    }

    # Ensure any auto-fixes are staged
    git add -A
  else
    echo "lint-staged not installed in apps/expo-app; skipping format-on-commit." >&2
  fi
else
  echo "npm not found; skipping Expo lint." >&2
fi
